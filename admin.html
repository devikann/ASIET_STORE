<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ASIET-Store</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            display: none; /* Hide page until admin is verified */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen">
    <div class="max-w-7xl mx-auto">
        <header class="bg-white shadow-md rounded-lg p-4 mb-6 flex justify-between items-center">
            <h1 id="welcomeMessage" class="text-3xl font-bold text-gray-800">üë®‚Äçüíº Admin Dashboard</h1>
            <div>
                <a href="student.html" class="text-blue-600 hover:text-blue-800 mr-4 font-medium">Student View</a>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Logout</button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Add/Edit Product Form -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit">
                <h2 id="formTitle" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 pb-2">Add New Product</h2>
                <form id="productForm" class="space-y-4">
                    <input type="hidden" id="productId">
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" id="productName" placeholder="T-shirt" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="productPrice" class="block text-sm font-medium text-gray-700 mb-1">Price (‚Çπ)</label>
                        <input type="number" id="productPrice" placeholder="500.00" step="0.01" min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="productStock" class="block text-sm font-medium text-gray-700 mb-1">Stock Quantity</label>
                        <input type="number" id="productStock" placeholder="20" min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="productDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="productDescription" placeholder="A comfortable college T-shirt" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                    </div>
                    <div>
                        <label for="productImageFile" class="block text-sm font-medium text-gray-700 mb-1">Product Image</label>
                        <input type="file" id="productImageFile" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <button type="submit" id="submitButton" class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Add Product</button>
                    <button type="button" id="cancelEditButton" class="w-full bg-gray-500 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-colors mt-2 hidden">Cancel Edit</button>
                    <div id="addFeedback" class="mt-4 text-center text-sm font-semibold"></div>
                </form>
            </div>

            <!-- Manage Existing Products -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 pb-2">Manage Existing Products</h2>
                <div id="productList" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">Loading products...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK and script logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, addDoc, onSnapshot, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';

        // Your final, correct Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBHe-cH8CbonOuHOy0RpHSx86jWNwKR42M",
            authDomain: "asiet-store.firebaseapp.com",
            projectId: "asiet-store",
            storageBucket: "asiet-store.firebasestorage.app",
            messagingSenderId: "618449805194",
            appId: "1:618449805194:web:e23310a335bd49aacab273",
            measurementId: "G-X04FWKQBQR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DOM ELEMENTS ---
        const welcomeMessage = document.getElementById('welcomeMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const productForm = document.getElementById('productForm');
        const formTitle = document.getElementById('formTitle');
        const submitButton = document.getElementById('submitButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const productIdInput = document.getElementById('productId');
        const productNameInput = document.getElementById('productName');
        const productPriceInput = document.getElementById('productPrice');
        const productStockInput = document.getElementById('productStock');
        const productDescriptionInput = document.getElementById('productDescription');
        const productImageFile = document.getElementById('productImageFile');
        const addFeedback = document.getElementById('addFeedback');
        const productListDiv = document.getElementById('productList');

        let currentProductToEdit = null;

        // --- AUTHENTICATION & PAGE PROTECTION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "students", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists() && userDocSnap.data().role === 'admin') {
                    document.body.style.display = 'block';
                    welcomeMessage.textContent = `üë®‚Äçüíº Welcome, Admin!`;
                    loadProducts();
                } else {
                    alert("Access Denied. You are not an administrator.");
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => { window.location.href = 'index.html'; });
        });

        // --- PRODUCT FORM LOGIC ---
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = productNameInput.value;
            const price = parseFloat(productPriceInput.value);
            const stock = parseInt(productStockInput.value);
            const description = productDescriptionInput.value;
            const imageFile = productImageFile.files[0];

            addFeedback.textContent = 'Processing...';
            addFeedback.classList.add('text-gray-500');

            try {
                let imageUrl = '';
                // Handle image upload if a new file is selected
                if (imageFile) {
                    const storageRef = ref(storage, `products/${Date.now()}_${imageFile.name}`);
                    await uploadBytes(storageRef, imageFile);
                    imageUrl = await getDownloadURL(storageRef);
                    addFeedback.textContent = 'Image uploaded. Saving product...';
                } else if (currentProductToEdit) {
                    // Retain old image URL if no new file is uploaded on edit
                    imageUrl = currentProductToEdit.imageUrl;
                } else {
                    // Use a placeholder if no image is uploaded and it's a new product
                    imageUrl = 'https://placehold.co/600x400/e2e8f0/3d4451?text=Product';
                }

                const productData = { name, price, stock, description, imageUrl };

                if (currentProductToEdit) {
                    // Update existing product
                    const docRef = doc(db, 'products', currentProductToEdit.id);
                    await updateDoc(docRef, productData);
                    addFeedback.textContent = '‚úÖ Product updated successfully!';
                    addFeedback.classList.add('text-green-500');
                    productForm.reset();
                    resetFormForAdd();
                } else {
                    // Add new product
                    await addDoc(collection(db, 'products'), productData);
                    addFeedback.textContent = '‚úÖ Product added successfully!';
                    addFeedback.classList.add('text-green-500');
                    productForm.reset();
                }
            } catch (error) {
                console.error("Error processing product: ", error);
                addFeedback.textContent = `‚ùå Error: ${error.message}`;
                addFeedback.classList.add('text-red-500');
            }

            setTimeout(() => { addFeedback.textContent = ''; addFeedback.classList.remove('text-green-500', 'text-red-500', 'text-gray-500'); }, 5000);
        });

        cancelEditButton.addEventListener('click', resetFormForAdd);

        function resetFormForAdd() {
            productForm.reset();
            currentProductToEdit = null;
            formTitle.textContent = 'Add New Product';
            submitButton.textContent = 'Add Product';
            cancelEditButton.classList.add('hidden');
        }

        // --- LOAD AND DISPLAY EXISTING PRODUCTS ---
        function loadProducts() {
            const productsCollection = collection(db, 'products');

            onSnapshot(productsCollection, (snapshot) => {
                if (snapshot.empty) {
                    productListDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No products found. Add one using the form!</p>';
                    return;
                }

                productListDiv.innerHTML = ''; // Clear previous list
                snapshot.forEach(doc => {
                    const product = { id: doc.id, ...doc.data() };
                    const productElement = document.createElement('div');
                    productElement.className = 'flex flex-col sm:flex-row items-center justify-between p-4 bg-gray-50 rounded-lg border gap-4';

                    productElement.innerHTML = `
                        <div class="flex items-center w-full sm:w-auto">
                            <img src="${product.imageUrl || 'https://placehold.co/100x100/e2e8f0/3d4451?text=Item'}" alt="${product.name}" class="w-16 h-16 object-cover rounded-md mr-4" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/3d4451?text=Item';">
                            <div>
                                <p class="font-bold text-gray-800">${product.name}</p>
                                <p class="text-sm text-gray-600">‚Çπ${product.price ? parseFloat(product.price).toFixed(2) : '0.00'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <button class="edit-btn bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" data-id="${product.id}">Edit</button>
                            <button class="delete-btn bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" data-id="${product.id}">Delete</button>
                        </div>
                    `;
                    productListDiv.appendChild(productElement);
                });
            });
        }

        // --- PRODUCT ACTIONS (EDIT & DELETE) ---
        productListDiv.addEventListener('click', async (e) => {
            const button = e.target;
            const docId = button.dataset.id;

            if (button.classList.contains('edit-btn')) {
                const productSnapshot = await getDoc(doc(db, 'products', docId));
                if (productSnapshot.exists()) {
                    const product = productSnapshot.data();
                    currentProductToEdit = { id: docId, ...product };
                    formTitle.textContent = 'Update Product';
                    submitButton.textContent = 'Save Changes';
                    cancelEditButton.classList.remove('hidden');

                    productNameInput.value = product.name;
                    productPriceInput.value = product.price;
                    productStockInput.value = product.stock;
                    productDescriptionInput.value = product.description;
                    // The file input can't be pre-filled for security reasons, but we have the URL
                    productImageFile.value = '';
                }
            } else if (button.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this product?')) {
                    const docRef = doc(db, 'products', docId);
                    try {
                        await deleteDoc(docRef);
                    } catch (error) {
                        console.error("Error deleting product: ", error);
                        alert("Failed to delete product.");
                    }
                }
            }
        });
    </script>
</body>
</html>
